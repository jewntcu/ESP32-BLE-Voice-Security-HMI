<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>行動安全系統藍牙控制器 (語音版)</title>
    <!-- 載入 Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設定 Tailwind 樣式和字體 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .log-area {
            height: 280px;
            overflow-y: scroll;
            scroll-behavior: smooth;
        }
        .control-btn {
            @apply p-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-opacity-50;
        }
        /* 設防/解除按鈕的樣式 */
        .state-btn-armed {
            @apply bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-500;
        }
        .state-btn-disarmed {
            @apply bg-green-500 text-white hover:bg-green-600 focus:ring-green-500;
        }
        .toggle-on {
            @apply bg-red-600 text-white hover:bg-red-700 focus:ring-red-600;
        }
        .toggle-off {
            @apply bg-gray-300 text-gray-800 hover:bg-gray-400 focus:ring-gray-300;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10 border-t-4 border-blue-600">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3 text-blue-600"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                行動安全系統藍牙控制器 (語音版)
            </h1>
            <p class="text-sm text-gray-500 mt-1">裝置回覆將以語音方式播報。</p>
        </header>

        <!-- 連線/狀態面板 (新增語音狀態) -->
        <section class="mb-8 p-5 bg-gray-100 rounded-xl flex flex-col justify-between items-center space-y-4 shadow-inner">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                <!-- 連線狀態 -->
                <div class="flex items-center space-x-3 p-3 bg-white rounded-lg shadow">
                    <div id="status-icon" class="p-2 rounded-full bg-gray-400 text-white">
                         <!-- 斷線圖示 SVG -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi-off"><path d="M5 2L2 5"/><path d="M22 22L2 22"/><path d="M2 12h20"/><path d="M22 5L5 22"/></svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500">連線狀態</p>
                        <p id="status-display" class="text-xl font-bold text-gray-800">未連線</p>
                    </div>
                </div>
                <!-- 語音狀態 -->
                <div class="flex items-center space-x-3 p-3 bg-white rounded-lg shadow">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><rect width="10" height="16" x="7" y="4" rx="3"/><path d="M12 20v4"/><path d="M10 9H8"/><path d="M16 9h-2"/></svg>
                    <div>
                        <p class="text-sm text-gray-500">語音 TTS</p>
                        <p id="speaker-status" class="text-base font-bold text-gray-800">載入中...</p>
                    </div>
                </div>
            </div>
            
            <button id="connect-button"
                    class="mt-4 py-3 w-full bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                啟動連線 (Web Bluetooth)
            </button>
        </section>

        <!-- 控制命令區塊 -->
        <section class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- 第二列：設防/解除設防 -->
            <button id="btn-arm" data-command="ARM" disabled
                    class="control-btn state-btn-disarmed col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M12 2L3 8v6c0 5.5 3.5 10.5 8 13.5M12 2V25"/><path d="M18 10L12 16L6 10"/></svg>
                <span class="font-bold text-lg">設防 (ARM)</span>
            </button>
            <button id="btn-disarm" data-command="DISARM" disabled
                    class="control-btn bg-gray-300 text-gray-800 hover:bg-gray-400 focus:ring-gray-300 col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M12 2L3 8v6c0 5.5 3.5 10.5 8 13.5M12 2V25"/><path d="M18 10L12 16L6 10"/></svg>
                <span class="font-bold text-lg">解除設防 (DISARM)</span>
            </button>
            
            <!-- 第三列：開門 / 開/關燈 / 開啟/解除警報 -->
            <button id="btn-door-open" data-command="DOOR_OPEN" disabled
                    class="control-btn bg-teal-500 text-white hover:bg-teal-600 focus:ring-teal-500">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M9 13v6"/><path d="M15 13v6"/><path d="M12 12v10"/></svg>
                <span class="font-medium">開門 (DOOR)</span>
            </button>
            
            <button id="btn-light-toggle" data-command="LIGHT_ON" data-off-command="LIGHT_OFF" disabled
                    class="control-btn toggle-off">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M15 14V11a3 3 0 0 0-6 0v3"/><path d="M8 20h8"/><path d="M12 14v6"/></svg>
                <span class="font-medium" id="light-label">開燈 (LIGHT)</span>
            </button>

            <button id="btn-alarm-toggle" data-command="ALARM_ON" data-off-command="ALARM_OFF" disabled
                    class="control-btn toggle-off col-span-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M10.85 10.85a.5.5 0 0 1 .7-.7l.39.39 1.48 1.48a.5.5 0 0 1 0 .7l-.39.39-1.48 1.48a.5.5 0 0 1-.7 0l-.39-.39-1.48-1.48a.5.5 0 0 1 0-.7l.39-.39z"/><path d="M21.7 4.3a.9.9 0 0 0 0-1.27l-1.07-1.07a.9.9 0 0 0-1.27 0L12 9.5 4.64 2.14a.9.9 0 0 0-1.27 0L2.3 3.07a.9.9 0 0 0 0 1.27L9.5 12l-7.14 7.36a.9.9 0 0 0 0 1.27l1.07 1.07a.9.9 0 0 0 1.27 0L12 14.5l7.36 7.14a.9.9 0 0 0 1.27 0l1.07-1.07a.9.9 0 0 0 0-1.27L14.5 12z"/></svg>
                <span class="font-medium" id="alarm-label">開啟警報 (ALARM)</span>
            </button>
            
            <!-- 第四列：語音測試按鈕 -->
            <button id="btn-tts-test" disabled
                    class="control-btn bg-purple-600 text-white hover:bg-purple-700 focus:ring-purple-600 col-span-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-1"><path d="M12 2a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                <span class="font-medium">測試語音播報</span>
            </button>
        </section>

        <!-- 訊息日誌區塊 (TX Characteristic Notifications) -->
        <section class="p-5 bg-gray-800 rounded-xl shadow-xl">
            <h2 class="text-xl font-semibold text-white mb-3 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-yellow-400"><path d="M2 12s3-3 5-3 5 3 5 3 3-3 5-3 5 3 5 3"/><path d="M22 22L2 22"/></svg>
                系統訊息日誌 (裝置回應)
            </h2>
            <div id="log-container" class="log-area p-3 bg-gray-900 text-green-400 rounded-lg text-sm font-mono">
                <!-- Log messages will be appended here -->
                <p>--- 應用程式已啟動 (語音 TTS 載入中...) ---</p>
            </div>
            <button id="clear-log-button" 
                    class="mt-3 py-1 px-4 text-xs bg-gray-600 text-white rounded hover:bg-gray-700 transition">
                清除日誌
            </button>
        </section>
    </div>

    <script type="module">
        // ----------------------------------------------------
        // 1. 環境初始化 (Firebase 和 Auth)
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) {
                signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.error("Firebase Custom Token 登入失敗:", e);
                    signInAnonymously(auth); 
                });
            } else {
                signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Firebase 初始化失敗:", error);
        }

        // ----------------------------------------------------
        // 2. Web Bluetooth API 邏輯 (核心)
        // ----------------------------------------------------
        
        // BLE NUS (Nordic UART Service) UUIDs 
        const BLE_UART_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_TX_CHARACTERISTIC_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; // 用於接收通知
        const BLE_RX_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; // 用於發送指令
        const COMMAND_TERMINATOR = '\n'; 

        // 狀態和特性值變數
        let bleDevice = null;
        let rxCharacteristic = null; 
        let txCharacteristic = null;
        let isArmed = false; 
        let isLightOn = false; // 追蹤燈光狀態
        let isAlarmOn = false; // 追蹤警報狀態

        // UI 元素
        const statusDisplay = document.getElementById('status-display');
        const statusIcon = document.getElementById('status-icon');
        const speakerStatus = document.getElementById('speaker-status');
        const connectButton = document.getElementById('connect-button');
        const logContainer = document.getElementById('log-container');
        const clearLogButton = document.getElementById('clear-log-button');
        const btnArm = document.getElementById('btn-arm');
        const btnDisarm = document.getElementById('btn-disarm');
        const btnLightToggle = document.getElementById('btn-light-toggle');
        const btnAlarmToggle = document.getElementById('btn-alarm-toggle');
        const btnTtsTest = document.getElementById('btn-tts-test');

        // Helper: Log message to UI
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const logElement = document.createElement('p');
            logElement.textContent = `[${time}] ${message}`;

            if (type === 'error') {
                logElement.className = 'text-red-400 font-bold';
            } else if (type === 'rx') { // 裝置回覆
                logElement.className = 'text-yellow-300';
            } else if (type === 'tx') { // 指令發送
                logElement.className = 'text-blue-300';
            } else { // info / system
                logElement.className = 'text-green-400';
            }
            
            logContainer.appendChild(logElement);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Helper: 更新連線/控制狀態 UI
        function updateUIState(isConnected, statusText = '未連線') {
            statusDisplay.textContent = statusText;
            
            // 更新狀態圖示和顏色 (與舊版邏輯一致)
            let iconSvg;
            if (statusText === '連線中') {
                statusDisplay.className = 'font-bold text-xl text-blue-600';
                statusIcon.className = 'p-2 rounded-full bg-blue-500 text-white animate-pulse';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
            } else if (isConnected && statusText !== '警報觸發!!!') {
                statusDisplay.className = 'font-bold text-xl text-green-600';
                statusIcon.className = 'p-2 rounded-full bg-green-500 text-white';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bluetooth"><path d="m7 7 10 10-5 5V2l5 5L7 17"/></svg>`;
            } else if (statusText === '警報觸發!!!') {
                 statusDisplay.className = 'font-bold text-xl text-red-600 animate-pulse';
                 statusIcon.className = 'p-2 rounded-full bg-red-600 text-white animate-bounce';
                 iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bell-ring"><path d="M12 21a2 2 0 0 1-2-2"/><path d="M18.832 9.475A12 12 0 0 0 5.168 9.475"/><path d="M2 12s3-3 5-3 5 3 5 3 3-3 5-3 5 3 5 3"/><path d="M22 22L2 22"/></svg>`;
            } else { // 未連線
                statusDisplay.className = 'font-bold text-xl text-red-600';
                statusIcon.className = 'p-2 rounded-full bg-gray-400 text-white';
                iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wifi-off"><path d="M5 2L2 5"/><path d="M22 22L2 22"/><path d="M2 12h20"/><path d="M22 5L5 22"/></svg>`;
                isArmed = false;
            }
            statusIcon.innerHTML = iconSvg;

            // 更新按鈕狀態
            connectButton.disabled = isConnected;
            connectButton.textContent = isConnected ? '已連線 (點擊斷開)' : '啟動連線 (Web Bluetooth)';
            document.querySelectorAll('button[id^="btn-"]').forEach(btn => btn.disabled = !isConnected);

            // 處理設防/解除按鈕的外觀
            btnArm.classList.remove('state-btn-armed', 'bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');
            btnDisarm.classList.remove('state-btn-disarmed', 'bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');

            if (isArmed) {
                btnArm.classList.add('state-btn-armed');
                btnDisarm.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');
                btnArm.disabled = true;
                btnDisarm.disabled = false;
            } else if (isConnected) {
                btnDisarm.classList.add('state-btn-disarmed');
                btnArm.classList.add('bg-gray-300', 'text-gray-800', 'hover:bg-gray-400', 'focus:ring-gray-300');
                btnArm.disabled = false;
                btnDisarm.disabled = true;
            }

            // 更新開/關燈按鈕外觀
            const lightLabel = document.getElementById('light-label');
            btnLightToggle.classList.remove('toggle-on', 'toggle-off');
            if (isLightOn) {
                btnLightToggle.classList.add('toggle-on');
                lightLabel.textContent = '關燈 (LIGHT)';
            } else {
                btnLightToggle.classList.add('toggle-off');
                lightLabel.textContent = '開燈 (LIGHT)';
            }
            
            // 更新開啟/解除警報按鈕外觀
            const alarmLabel = document.getElementById('alarm-label');
            btnAlarmToggle.classList.remove('toggle-on', 'toggle-off');
            if (isAlarmOn) {
                btnAlarmToggle.classList.add('toggle-on');
                alarmLabel.textContent = '解除警報 (ALARM)';
            } else {
                btnAlarmToggle.classList.add('toggle-off');
                alarmLabel.textContent = '開啟警報 (ALARM)';
            }
        }
        
        // ----------------------------------------------------
        // 3. 語音合成 (TTS) 邏輯 (使用 Gemini API)
        // ----------------------------------------------------
        
        // 將 Base64 字符串轉換為 ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // 將 PCM 數據轉換為 WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const bytesPerSample = bitsPerSample / 8;
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            
            const buffer = new ArrayBuffer(44 + pcm16.length * bytesPerSample);
            const view = new DataView(buffer);
            
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            // RIFF header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + pcm16.length * bytesPerSample, true);
            writeString(view, 8, 'WAVE');
            
            // Format chunk
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            
            // Data chunk
            writeString(view, 36, 'data');
            view.setUint32(40, pcm16.length * bytesPerSample, true);
            
            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++, offset += 2) {
                view.setInt16(offset, pcm16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        // 核心 TTS 函數
        async function speakText(text) {
            const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=`;
            const MAX_RETRIES = 5;
            const VOICE_NAME = "Kore"; // 使用 Kore 聲音
            let lastError = null;
            
            if (!text.trim()) return;

            speakerStatus.textContent = '語音合成中...';
            speakerStatus.classList.remove('text-green-500', 'text-red-500');
            speakerStatus.classList.add('text-yellow-500');

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: text }] }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: { prebuiltVoiceConfig: { voiceName: VOICE_NAME } }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const response = await fetch(TTS_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API returned status ${response.status}`);
                    }

                    const result = await response.json();
                    const part = result?.candidates?.[0]?.content?.parts?.[0];
                    const audioData = part?.inlineData?.data;
                    const mimeType = part?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/")) {
                        const rateMatch = mimeType.match(/rate=(\d+)/);
                        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
                        
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        audio.play();

                        audio.onended = () => {
                            URL.revokeObjectURL(audioUrl);
                            speakerStatus.textContent = '語音待命中';
                            speakerStatus.classList.remove('text-yellow-500');
                            speakerStatus.classList.add('text-green-500');
                        };
                        
                        return; // 成功
                    } else {
                        throw new Error("TTS API 響應結構錯誤或沒有音頻數據。");
                    }

                } catch (e) {
                    lastError = e;
                    if (attempt < MAX_RETRIES - 1) {
                        const delay = Math.pow(2, attempt) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }
            }

            // 所有重試失敗
            console.error("TTS API 連續重試失敗。", lastError);
            log(`語音合成失敗: ${lastError.message}`, 'error');
            speakerStatus.textContent = '語音錯誤';
            speakerStatus.classList.add('text-red-500');
        }

        // 處理裝置回覆並進行語音播報
        function speakResponse(reply) {
            // 清理回覆字串，以便 TTS 播報
            let cleanedText = reply.trim();
            // 替換已知的裝置前綴為更自然的語音
            if (cleanedText.includes('LP_DATA')) {
                cleanedText = cleanedText.replace('LP_DATA:', '安全系統數據：');
            } else if (cleanedText.includes('ARMED')) {
                cleanedText = '安全系統，已設防！';
            } else if (cleanedText.includes('DISARMED')) {
                cleanedText = '安全系統，解除設防！';
            } else if (cleanedText.includes('DOOR_OPEN')) {
                cleanedText = '電子門鎖已開啟。';
            } else if (cleanedText.includes('LIGHT_ON')) {
                cleanedText = '照明已開啟。';
            } else if (cleanedText.includes('LIGHT_OFF')) {
                cleanedText = '照明已關閉。';
            } else if (cleanedText.includes('ALARM_ON')) {
                cleanedText = '蜂鳴器和警示燈已啟動。';
            } else if (cleanedText.includes('ALARM_OFF')) {
                cleanedText = '警報已解除。';
            } else if (cleanedText.includes('ALARM_TRIGGERED')) {
                cleanedText = '警報觸發！請立即檢查！';
            }
            speakText(cleanedText);
        }

        // --- BLE 核心功能 ---

        // 處理來自 TX Characteristic 的數據通知
        function handleNotifications(event) {
            const value = event.target.value;
            const data = new TextDecoder().decode(value).trim();
            log(`裝置回覆: ${data}`, 'rx');

            // 新增：呼叫語音回覆
            speakResponse(data);

            // 處理狀態更新
            if (data.includes('ARMED')) {
                isArmed = true;
                updateUIState(true, '設防中 (ARMED)');
            } else if (data.includes('DISARMED')) {
                isArmed = false;
                updateUIState(true, '解除設防 (DISARMED)');
            } else if (data.includes('ALARM_TRIGGERED')) {
                updateUIState(true, '警報觸發!!!');
                isAlarmOn = true; // 假設警報觸發會開啟蜂鳴器
            } else if (data.includes('LIGHT_ON')) {
                isLightOn = true;
            } else if (data.includes('LIGHT_OFF')) {
                isLightOn = false;
            } else if (data.includes('ALARM_ON')) {
                isAlarmOn = true;
            } else if (data.includes('ALARM_OFF')) {
                isAlarmOn = false;
            }
            updateUIState(bleDevice?.gatt?.connected || false, statusDisplay.textContent);
        }

        // 處理裝置斷開連線
        function onDisconnected(event) {
            log(`裝置已斷開連線: ${event.target.name || 'Unknown Device'}`, 'error');
            updateUIState(false);
            bleDevice = null;
            rxCharacteristic = null;
            txCharacteristic = null;
        }
        
        // 發送指令到 RX Characteristic
        async function sendCommand(command) {
            if (!rxCharacteristic) {
                log('發送失敗: 尚未連線到裝置。', 'error');
                updateUIState(false, '連線失敗');
                return;
            }
            
            const fullCommand = command + COMMAND_TERMINATOR;

            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(fullCommand);
                await rxCharacteristic.writeValue(data);
                log(`發送指令: ${fullCommand.trim()}`, 'tx');

                // 立即更新 UI 狀態 (假設指令執行成功，正式狀態需等待 TX 通知)
                if (command === 'LIGHT_ON') isLightOn = true;
                if (command === 'LIGHT_OFF') isLightOn = false;
                if (command === 'ALARM_ON') isAlarmOn = true;
                if (command === 'ALARM_OFF') isAlarmOn = false;
                updateUIState(true, statusDisplay.textContent);

            } catch (error) {
                log(`發送指令失敗: ${error.message}`, 'error');
            }
        }

        // 連線流程
        async function connect() {
            if (typeof window === 'undefined' || !navigator.bluetooth) {
                log('錯誤: 瀏覽器不支援 Web Bluetooth API。請使用 Chrome/Edge 瀏覽器。', 'error');
                updateUIState(false, '不支援 BLE');
                return;
            }

            updateUIState(false, '掃描中...');
            connectButton.disabled = true;

            try {
                bleDevice = await navigator.bluetooth.requestDevice({
                    // 根據 ESP32 韌體中的藍牙名稱過濾，如果您設定了名稱，可以加上 filters: [{ name: 'ESP32_Secure_Controller' }]
                    filters: [{ services: [BLE_UART_SERVICE_UUID] }],
                    optionalServices: [BLE_UART_SERVICE_UUID], 
                });

                log(`已找到裝置: ${bleDevice.name || bleDevice.id}`);
                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);

                updateUIState(false, '連線 GATT 伺服器...');
                const server = await bleDevice.gatt.connect();

                updateUIState(false, '取得特性值...');
                const service = await server.getPrimaryService(BLE_UART_SERVICE_UUID);
                rxCharacteristic = await service.getCharacteristic(BLE_RX_CHARACTERISTIC_UUID);
                txCharacteristic = await service.getCharacteristic(BLE_TX_CHARACTERISTIC_UUID);
                
                await txCharacteristic.startNotifications();
                txCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);

                updateUIState(true, '解除設防 (DISARMED)'); 
                isArmed = false;
                log('*** 成功連線到裝置！ ***');
                speakText('藍牙連線成功，系統已就緒。');

            } catch (error) {
                log(`連線失敗: ${error.name || error.message}`, 'error');
                speakText('藍牙連線失敗。');
                updateUIState(false);
            } finally {
                connectButton.disabled = false;
            }
        }
        
        // --- 事件監聽器 ---
        connectButton.addEventListener('click', () => {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            } else {
                connect();
            }
        });
        
        // 設防/解除設防按鈕事件
        document.getElementById('btn-arm').addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) sendCommand('ARM');
        });
        document.getElementById('btn-disarm').addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) sendCommand('DISARM');
        });

        // 開門按鈕事件
        document.getElementById('btn-door-open').addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) sendCommand('DOOR_OPEN');
        });

        // 開/關燈切換按鈕事件
        btnLightToggle.addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) {
                const command = isLightOn ? e.currentTarget.dataset.offCommand : e.currentTarget.dataset.command;
                sendCommand(command);
            }
        });

        // 開啟/解除警報切換按鈕事件
        btnAlarmToggle.addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) {
                const command = isAlarmOn ? e.currentTarget.dataset.offCommand : e.currentTarget.dataset.command;
                sendCommand(command);
            }
        });

        // 語音測試按鈕事件
        btnTtsTest.addEventListener('click', (e) => {
            if (!e.currentTarget.disabled) {
                speakText("這是一段語音測試，系統工作正常。");
            }
        });

        clearLogButton.addEventListener('click', () => {
            logContainer.innerHTML = '<p>--- 日誌已清除 ---</p>';
        });

        // 應用程式啟動時的初始狀態
        updateUIState(false);
        // 設定語音狀態的初始文字
        speakerStatus.textContent = '語音待命中';
        speakerStatus.classList.add('text-green-500');

    </script>
</body>
</html>

