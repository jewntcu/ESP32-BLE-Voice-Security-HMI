<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œå‹•å®‰å…¨ç³»çµ± (èªéŸ³)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .log-area { height: 280px; overflow-y: scroll; scroll-behavior: smooth; font-family: 'Courier New', monospace; }
        .control-btn { @apply p-4 rounded-xl shadow-lg transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none text-lg font-bold; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        /* èªéŸ³æŒ‰éˆ•çš„å°ˆå±¬å‹•ç•« */
        .listening { animation: pulse 1.5s infinite; border: 2px solid #ef4444; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white shadow-2xl rounded-2xl p-6 md:p-10 border-t-4 border-purple-600">
        <header class="mb-8 text-center sm:text-left">
            <h1 class="text-3xl font-bold text-gray-800">è¡Œå‹•å®‰å…¨ç³»çµ± (èªéŸ³ç‰ˆ)</h1>
            <p class="text-sm text-gray-500 mt-1">Web Bluetooth + Web Speech API (V23 ç›¸å®¹)</p>
        </header>

        <!-- é€£ç·šç‹€æ…‹ -->
        <section class="mb-8 p-5 bg-gray-100 rounded-xl flex flex-col sm:flex-row justify-between items-center gap-4 shadow-inner">
            <div class="flex items-center gap-3">
                <div class="p-2 rounded-full bg-gray-400 text-white" id="status-icon">âš¡</div>
                <div><p class="text-sm text-gray-500">é€£ç·šç‹€æ…‹</p><p id="status-display" class="text-xl font-bold text-gray-800">æœªé€£ç·š</p></div>
            </div>
            <button id="connect-button" class="w-full sm:w-auto py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition">å•Ÿå‹•é€£ç·š</button>
        </section>

        <!-- æ§åˆ¶å‘½ä»¤ -->
        <section class="grid grid-cols-2 gap-4 mb-8">
            <button id="btn-arm" data-cmd="ARM" disabled class="control-btn bg-yellow-500 text-white">è¨­é˜² (ARM)</button>
            <button id="btn-disarm" data-cmd="DISARM" disabled class="control-btn bg-gray-300 text-gray-600">è§£é™¤ (DISARM)</button>

            <button id="btn-door" data-cmd="DOOR_OPEN" disabled class="control-btn bg-teal-500 text-white">é–‹é–€</button>
            <button id="btn-light" data-cmd="LIGHT_TOGGLE" disabled class="control-btn bg-indigo-500 text-white">é–‹/é—œç‡ˆ</button>
            
            <button id="btn-alarm" data-cmd="ALARM_TOGGLE" disabled class="control-btn bg-red-500 text-white col-span-2">é–‹/é—œè­¦å ±</button>
            <button id="btn-log" data-cmd="READ_LOG" disabled class="control-btn bg-purple-600 text-white hover:bg-purple-700 col-span-2">è®€å–ç´€éŒ„</button>

            <!-- èªéŸ³æŒ‰éˆ• -->
            <button id="btn-voice" disabled class="control-btn bg-pink-500 text-white hover:bg-pink-600 col-span-2 flex items-center justify-center gap-2">
                ğŸ¤ é»æ“Šèªªè©± (ä¸­æ–‡)
            </button>
        </section>

        <!-- æ—¥èªŒ -->
        <section class="p-5 bg-gray-800 rounded-xl shadow-xl">
            <h2 class="text-xl font-semibold text-white mb-3">ç³»çµ±æ—¥èªŒ & ç´€éŒ„</h2>
            <div id="log-container" class="log-area p-3 bg-gray-900 text-green-400 rounded-lg text-sm"><p>--- ç­‰å¾…é€£ç·š ---</p></div>
            <button id="clear-log" class="mt-3 py-1 px-4 text-xs bg-gray-600 text-white rounded">æ¸…é™¤æ—¥èªŒ</button>
        </section>
    </div>

    <script type="module">
        const BLE_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const BLE_TX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e'; 
        const BLE_RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e'; 
        const TERMINATOR = '\n'; 

        let bleDevice, rxChar, txChar, isConnected = false;
        let isArmed = false, isLightOn = false, isAlarmOn = false;

        const statusDisplay = document.getElementById('status-display');
        const statusIcon = document.getElementById('status-icon');
        const connectBtn = document.getElementById('connect-button');
        const logContainer = document.getElementById('log-container');
        const btnVoice = document.getElementById('btn-voice');
        
        // UI Elements
        const btnArm = document.getElementById('btn-arm');
        const btnDisarm = document.getElementById('btn-disarm');
        const btnDoor = document.getElementById('btn-door');
        const btnLight = document.getElementById('btn-light');
        const btnAlarm = document.getElementById('btn-alarm');
        const btnLog = document.getElementById('btn-log');

        let recognition = null;
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'zh-TW'; // è¨­å®šä¸­æ–‡å°ç£
            
            recognition.onstart = () => {
                btnVoice.classList.add('listening');
                btnVoice.textContent = 'ğŸ”´ è†è½ä¸­... è«‹èªªè©±';
                log('èªéŸ³: é–‹å§‹è†è½...', 'info');
            };

            recognition.onerror = (event) => {
                btnVoice.classList.remove('listening');
                btnVoice.textContent = 'ğŸ¤ é»æ“Šèªªè©± (ä¸­æ–‡)';
                log(`èªéŸ³éŒ¯èª¤: ${event.error}`, 'error');
            };

            recognition.onend = () => {
                btnVoice.classList.remove('listening');
                btnVoice.textContent = 'ğŸ¤ é»æ“Šèªªè©± (ä¸­æ–‡)';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                log(`èªéŸ³è¾¨è­˜çµæœ: ${transcript}`, 'info');
                processVoiceCommand(transcript);
            };
        } else {
            // ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³
            document.addEventListener('DOMContentLoaded', () => {
                btnVoice.disabled = true;
                btnVoice.textContent = 'âŒ ä¸æ”¯æ´èªéŸ³è¼¸å…¥';
                btnVoice.classList.add('bg-gray-500');
            });
        }


        function log(msg, type="info") {
            const p = document.createElement('p');
            p.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            if (type === 'rx') p.className = "text-yellow-300";
            if (type === 'data') p.className = "text-cyan-300 font-bold";
            if (type === 'error') p.className = "text-red-500 font-bold";
            logContainer.appendChild(p);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateUI() {
            connectBtn.textContent = isConnected ? "æ–·é–‹é€£ç·š" : "å•Ÿå‹•é€£ç·š";
            statusDisplay.textContent = isConnected ? (isArmed ? "å·²é€£ç·š (è¨­é˜²ä¸­)" : "å·²é€£ç·š (è§£é™¤è¨­é˜²)") : "æœªé€£ç·š";
            statusDisplay.className = isConnected ? (isArmed ? "text-xl font-bold text-yellow-600" : "text-xl font-bold text-green-600") : "text-xl font-bold text-red-600";
            statusIcon.className = isConnected ? (isArmed ? "p-2 rounded-full bg-yellow-500 text-white" : "p-2 rounded-full bg-green-500 text-white") : "p-2 rounded-full bg-gray-400 text-white";

            [btnDoor, btnLight, btnAlarm, btnLog].forEach(btn => btn.disabled = !isConnected);
            if (recognition) btnVoice.disabled = !isConnected;
            
            if(isConnected) {
                btnArm.disabled = isArmed;
                btnDisarm.disabled = !isArmed;
                
                // Button Styling
                if(isArmed) {
                    btnArm.className = "control-btn bg-gray-300 text-gray-500";
                    btnDisarm.className = "control-btn bg-green-500 text-white hover:bg-green-600";
                } else {
                    btnArm.className = "control-btn bg-yellow-500 text-white hover:bg-yellow-600";
                    btnDisarm.className = "control-btn bg-gray-300 text-gray-600";
                }
                
                btnLight.textContent = isLightOn ? "é—œç‡ˆ (OFF)" : "é–‹ç‡ˆ (ON)";
                btnAlarm.textContent = isAlarmOn ? "è§£é™¤è­¦å ± (OFF)" : "é–‹å•Ÿè­¦å ± (ON)";
            } else {
                btnArm.disabled = true; 
                btnDisarm.disabled = true;
                btnArm.className = "control-btn bg-gray-300 text-gray-500";
                btnDisarm.className = "control-btn bg-gray-300 text-gray-600";
            }
        }

        // V23 æ ¸å¿ƒè§£æé‚è¼¯ï¼šå°‡ LP-2010 å›å‚³çš„ 12-byte HEX å­—ä¸²è½‰æ›ç‚ºæ—¥æœŸæ™‚é–“å’Œå¡è™Ÿ
        function parseLogData(hexStr) {
            const bytes = hexStr.replace(/'/g, '').trim().split(' ').map(b => parseInt(b, 16)).filter(b => !isNaN(b));
            if (bytes.length < 12) return hexStr + " (æ ¼å¼éŒ¯èª¤)"; 
            
            const b0 = bytes[0], b1 = bytes[1], b2 = bytes[2], b3 = bytes[3];
            
            const year = 2000 + (b0 >> 2);
            const month = ((b0 & 0x03) << 2) | (b1 >> 6);
            const day = (b1 >> 1) & 0x1F;
            const hour = ((b1 & 0x01) << 4) | (b2 >> 4);
            const minute = ((b2 & 0x0F) << 2) | (b3 >> 6);
            const second = b3 & 0x3F;
            
            const dateStr = `${year}/${month.toString().padStart(2,'0')}/${day.toString().padStart(2,'0')} ${hour.toString().padStart(2,'0')}:${minute.toString().padStart(2,'0')}:${second.toString().padStart(2,'0')}`;
            
            const cardId = bytes.slice(4, 12).map(b => b.toString(16).toUpperCase().padStart(2,'0')).join(' ');
            
            return `[ç´€éŒ„] æ™‚é–“: ${dateStr} | å¡è™Ÿ: ${cardId}`;
        }

        function handleNotifications(event) {
            const val = new TextDecoder().decode(event.target.value).trim();
            
            // ç‹€æ…‹åŒæ­¥
            if (val.includes("STATUS: ARMED")) { isArmed = true; isAlarmOn = false; updateUI(); }
            else if (val.includes("STATUS: DISARMED")) { isArmed = false; isAlarmOn = false; updateUI(); }
            else if (val.includes("STATUS: LIGHT_ON")) { isLightOn = true; updateUI(); }
            else if (val.includes("STATUS: LIGHT_OFF")) { isLightOn = false; updateUI(); }
            else if (val.includes("STATUS: ALARM_ON")) { isAlarmOn = true; updateUI(); }
            else if (val.includes("STATUS: ALARM_OFF")) { isAlarmOn = false; updateUI(); }
            else if (val.includes("ALARM_TRIGGERED:")) { 
                isArmed = true; isAlarmOn = true; updateUI(); 
                log(val, 'error');
            }
            
            // æ—¥èªŒæ•¸æ“šè™•ç†
            else if (val.startsWith("LOG_DATA:")) {
                const rawData = val.substring(9).trim();
                if (rawData.includes("'")) { 
                     log(parseLogData(rawData), 'data');
                } else {
                     log(`[æ—¥èªŒåŸå§‹è³‡æ–™] ${rawData}`, 'data');
                }
            } else {
                log("RX: " + val, 'rx');
            }
        }

        async function sendCommand(cmd) {
            if (!rxChar) return log('éŒ¯èª¤: è—ç‰™ç‰¹å¾µå€¼æœªåˆå§‹åŒ–', 'error');
            try {
                // è™•ç† Toggle é‚è¼¯
                let finalCmd = cmd;
                if (cmd === 'LIGHT_TOGGLE') finalCmd = isLightOn ? 'LIGHT_OFF' : 'LIGHT_ON';
                if (cmd === 'ALARM_TOGGLE') finalCmd = isAlarmOn ? 'ALARM_OFF' : 'ALARM_ON';
                
                await rxChar.writeValue(new TextEncoder().encode(finalCmd + TERMINATOR));
                log('TX: ' + finalCmd);
                
                // å‰ç«¯æš«æ™‚æ›´æ–°ç‹€æ…‹ï¼Œç­‰å¾… ESP32 ç¢ºèª
                if (finalCmd === 'LIGHT_ON') isLightOn = true;
                if (finalCmd === 'LIGHT_OFF') isLightOn = false;
                if (finalCmd === 'ALARM_ON') isAlarmOn = true;
                if (finalCmd === 'ALARM_OFF') isAlarmOn = false;
                updateUI();
            } catch(e) { log('ç™¼é€å¤±æ•—: ' + e.message, 'error'); }
        }
        
        // èªéŸ³æŒ‡ä»¤è™•ç†å‡½å¼
        function processVoiceCommand(text) {
            let cmdToSend = null;
            const t = text.replace(/ /g, ''); // ç§»é™¤ç©ºæ ¼

            if (t.includes('è¨­é˜²')) { cmdToSend = 'ARM'; }
            else if (t.includes('è§£é™¤') || t.includes('è§£é˜²')) { cmdToSend = 'DISARM'; }
            else if (t.includes('é–‹é–€')) { cmdToSend = 'DOOR_OPEN'; }
            else if (t.includes('é–‹ç‡ˆ')) { cmdToSend = 'LIGHT_ON'; }
            else if (t.includes('é—œç‡ˆ')) { cmdToSend = 'LIGHT_OFF'; }
            else if (t.includes('é–‹å•Ÿè­¦å ±')) { cmdToSend = 'ALARM_ON'; }
            else if (t.includes('é—œé–‰è­¦å ±') || t.includes('è§£é™¤è­¦å ±')) { cmdToSend = 'ALARM_OFF'; }
            else if (t.includes('è®€å–ç´€éŒ„') || t.includes('è®€ç´€éŒ„')) { cmdToSend = 'READ_LOG'; }
            
            if (cmdToSend) {
                log(`[èªéŸ³åŸ·è¡Œ] æŒ‡ä»¤: ${cmdToSend}`, 'info');
                // å°æ–¼ LIGHT å’Œ ALARMï¼Œå¦‚æœç”¨æˆ¶èªª "é–‹ç‡ˆ" æˆ– "é—œç‡ˆ"ï¼Œæˆ‘å€‘ç™¼é€æ˜ç¢ºæŒ‡ä»¤
                // è€Œé TOGGLEï¼Œä»¥ç¢ºä¿èªéŸ³æŒ‡ä»¤çš„ç¢ºå®šæ€§
                if (cmdToSend.includes('LIGHT') && cmdToSend !== 'LIGHT_TOGGLE') {
                    sendCommand(cmdToSend);
                } else if (cmdToSend.includes('ALARM') && cmdToSend !== 'ALARM_TOGGLE') {
                    sendCommand(cmdToSend);
                } else {
                    sendCommand(cmdToSend);
                }
            } else {
                log(`[èªéŸ³åŸ·è¡Œ] ç„¡æ³•è­˜åˆ¥æŒ‡ä»¤: ${text}`, 'error');
            }
        }


        async function connect() {
             if (!navigator.bluetooth) return alert('éŒ¯èª¤: æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetooth APIã€‚è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨ã€‚');
             try {
                 log('æƒæè£ç½®...');
                 bleDevice = await navigator.bluetooth.requestDevice({ filters: [{ services: [BLE_SERVICE_UUID] }] });
                 bleDevice.addEventListener('gattserverdisconnected', () => { isConnected=false; updateUI(); log("é€£ç·šå·²ä¸­æ–·"); });
                 const server = await bleDevice.gatt.connect();
                 const service = await server.getPrimaryService(BLE_SERVICE_UUID);
                 rxChar = await service.getCharacteristic(BLE_RX_UUID);
                 txChar = await service.getCharacteristic(BLE_TX_UUID);
                 await txChar.startNotifications();
                 txChar.addEventListener('characteristicvaluechanged', handleNotifications);
                 isConnected = true; isArmed = false; 
                 updateUI();
                 log('é€£ç·šæˆåŠŸï¼è«‹ç­‰å¾…ç³»çµ±ç‹€æ…‹åŒæ­¥...');
             } catch(e) { log('é€£ç·šå¤±æ•—: ' + e.message, 'error'); }
        }

        connectBtn.addEventListener('click', () => isConnected ? bleDevice.gatt.disconnect() : connect());
        btnArm.addEventListener('click', () => sendCommand('ARM'));
        btnDisarm.addEventListener('click', () => sendCommand('DISARM'));
        btnDoor.addEventListener('click', () => sendCommand('DOOR_OPEN'));
        btnLight.addEventListener('click', () => sendCommand('LIGHT_TOGGLE'));
        btnAlarm.addEventListener('click', () => sendCommand('ALARM_TOGGLE'));
        btnLog.addEventListener('click', () => sendCommand('READ_LOG'));
        btnVoice.addEventListener('click', () => {
            if (recognition && isConnected) {
                recognition.start();
            }
        });
        document.getElementById('clear-log').addEventListener('click', () => logContainer.innerHTML = '<p>--- æ—¥èªŒå·²æ¸…é™¤ ---</p>');
        
        updateUI();
    </script>
</body>
</html>

